#include <Preferences.h>

#define EEPROM_MODE_READ_WRITE false
#define EEPROM_MODE_READ true
#define KEY_NAME "init"

class MyClass {
public:
  Preferences preferences;
};

MyClass myClass;

void write_init_value(bool value) {
    // 1. Open ONLY for writing
    if (myClass.preferences.begin("namespace", EEPROM_MODE_READ_WRITE)) {
        myClass.preferences.putBool(KEY_NAME, value);
        myClass.preferences.end(); // Close the write session
    } else {
        Serial.println("Write begin failed!");
    }
}

void setup() {
    Serial.begin(115200);

    // 1. Check if key exists (requires temporary read access)
    bool key_exists = false;
    if (myClass.preferences.begin("namespace", EEPROM_MODE_READ)) {
        key_exists = myClass.preferences.isKey(KEY_NAME);
        myClass.preferences.end(); // Close the check session
    }

    if (!key_exists) {
        Serial.printf("no key named \"%s\"\n", KEY_NAME);
        write_init_value(true); // Write 1
    }

    // 2. Final Write (always run this part)
    write_init_value(false); // Write 0

    // 3. Final Open for reading in loop()
    // Open once, and leave it open for subsequent reads in loop()
    if (!myClass.preferences.begin("namespace", EEPROM_MODE_READ)) {
        Serial.println("FATAL: Final read-open failed!");
    }
}

void loop() {
    if (Serial.available()) {
        Serial.parseInt();
        // Now this read should reliably fetch the '0' from flash
        printf("%s-iskey: %d\n", KEY_NAME, myClass.preferences.isKey(KEY_NAME));
        printf("%s: %d\n", KEY_NAME, myClass.preferences.getBool(KEY_NAME));
    }
}

/* 
void setup() {
  Serial.begin(115200);

  myClass.preferences.begin("namespace", EEPROM_MODE_READ);

  if (!myClass.preferences.isKey(KEY_NAME)) {
    Serial.printf("no key named \"%s\"\n", KEY_NAME);

    myClass.preferences.end();
    myClass.preferences.begin("namespace", EEPROM_MODE_READ_WRITE);

    myClass.preferences.putBool(KEY_NAME, true);

    myClass.preferences.end();
  }

  myClass.preferences.begin("namespace", EEPROM_MODE_READ_WRITE);
  myClass.preferences.putBool(KEY_NAME, false);
  myClass.preferences.end();
  
  myClass.preferences.begin("namespace", EEPROM_MODE_READ);
}

void loop() {
  if (Serial.available()) {
    Serial.parseInt();
    printf("%s-iskey: %d\n", KEY_NAME, myClass.preferences.isKey(KEY_NAME));
    printf("%s: %d\n", KEY_NAME, myClass.preferences.getBool(KEY_NAME));
  }
}
*/